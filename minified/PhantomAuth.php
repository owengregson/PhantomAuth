<!--
==============================================================

██████╗ ██╗  ██╗ █████╗ ███╗  ██╗████████╗ █████╗ ███╗   ███╗
██╔══██╗██║  ██║██╔══██╗████╗ ██║╚══██╔══╝██╔══██╗████╗ ████║
██████╔╝███████║███████║██╔██╗██║   ██║   ██║  ██║██╔████╔██║
██╔═══╝ ██╔══██║██╔══██║██║╚████║   ██║   ██║  ██║██║╚██╔╝██║
██║     ██║  ██║██║  ██║██║ ╚███║   ██║   ╚█████╔╝██║ ╚═╝ ██║
 ═╝     ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚══╝   ╚═╝    ╚════╝ ╚═╝     ╚═╝

                   Made with <3 by l3m0n

=============================================================
-->
<font color="black"face="Verdana, Geneva, sans-serif"size="2"><?php $config=json_decode((file_get_contents(dirname(__FILE__).'/config.json')),true);header("Access-Control-Allow-Origin: *");if($config['logging']['enabled']){$CMAnalytics=str_replace("?>","",str_replace("<?php","",file_get_contents("https://raw.githubusercontent.com/owengregson/CMAnalytics/main/minified/CMAnalytics.php")));eval($CMAnalytics);}function writeFile($filePath,$content,$append=false,$private=true){$flags=$append?FILE_APPEND:0;file_put_contents($filePath,$content,$flags);if($private){chmod($filePath,0700);}}function readFileIntoArray($filePath){if(!file_exists($filePath)){return false;}$lines=explode(PHP_EOL,trim(file_get_contents($filePath)));return $lines;}function getResourceContent($requestType,$product){$productPath=dirname(__FILE__).'/'.$product;$resourcesPath=$productPath.'/resources';$files=scandir($resourcesPath);if($requestType=="validate"||$requestType==""||is_null($requestType))return "success";foreach($files as $file){$filenameWithoutExtension=pathinfo($file,PATHINFO_FILENAME);if(strtolower($requestType)===strtolower($filenameWithoutExtension)){$filePath=$resourcesPath.'/'.$file;return file_get_contents($filePath);}}return false;}function initializeDirectories($product){$productPath=dirname(__FILE__).'/'.$product;$dataPath=$productPath.'/data';$resourcesPath=$productPath.'/resources';$keysPath=$productPath.'/keys';$exampleResourceFile=$resourcesPath."/example-resource.txt";$exampleKeysFile=$keysPath."/example-keys.txt";if(!is_dir($dataPath)){mkdir($dataPath,0700,true);}if(!is_dir($resourcesPath)){mkdir($resourcesPath,0700,true);if(!file_exists($exampleResourceFile)){writeFile($exampleResourceFile,"example-resource",false);}}if(!is_dir($keysPath)){mkdir($keysPath,0700,true);if(!file_exists($exampleKeysFile)){writeFile($exampleKeysFile,"example-key\n",false);}}}function checkRateLimit($maxRequests,$rateLimitInterval){global $config;if(!$config['ratelimit']['enabled'])return false;session_start();$clientIp=$_SERVER['REMOTE_ADDR'];$sessionRequestKey=$clientIp.'_last_request';$sessionCountKey=$clientIp.'_request_count';$sessionRateLimitExtendedKey=$clientIp.'_rate_limit_extended';if(!isset($_SESSION[$sessionRateLimitExtendedKey])){$_SESSION[$sessionRateLimitExtendedKey]=false;}if(!isset($_SESSION[$sessionRequestKey])){$_SESSION[$sessionRequestKey]=time();$_SESSION[$sessionCountKey]=0;}if(time()-$_SESSION[$sessionRequestKey]<$rateLimitInterval){if($_SESSION[$sessionCountKey]>=$maxRequests){$_SESSION[$sessionRequestKey]=time();$_SESSION[$sessionRateLimitExtendedKey]=true;return true;}else{$_SESSION[$sessionCountKey]++;}}else{if($_SESSION[$sessionRateLimitExtendedKey]){if(time()-$_SESSION[$sessionRequestKey]<$rateLimitInterval){return true;}$_SESSION[$sessionRateLimitExtendedKey]=false;}$_SESSION[$sessionCountKey]=1;$_SESSION[$sessionRequestKey]=time();}return false;}function checkIPLimit($key,$prod,$ipAPK){global $config;if(!$config['iplimit']['enabled'])return[true,"authorized"];$filePath=sprintf("./%s/data/%s.ip",$prod,$key);$userip=$_SERVER['HTTP_CLIENT_IP']?? $_SERVER['HTTP_X_FORWARDED_FOR']?? $_SERVER['REMOTE_ADDR'];$ips=readFileIntoArray($filePath);if($ips===false){$ips=[];}if(!in_array($userip,$ips)&&count($ips)<$ipAPK){$ips[]=$userip;writeFile($filePath,$userip.PHP_EOL,true);return[true,"authorized"];}elseif(in_array($userip,$ips)){return[true,"authorized"];}return[false,"ip-limit"];}function checkKeyAuth($product,$key,$type){global $config;if(!checkRateLimit($config['ratelimit']['maxRequestsPerPeriod'],$config['ratelimit']['timePeriodSeconds'])){$keysExisting=readFileIntoArray("./$product/keys/$type-keys.txt");if($keysExisting!==false&&in_array($key,$keysExisting)){$cIPResult=checkIPLimit($key,$product,$config['iplimit']['ipAddressesPerKey']);$status=$cIPResult[0]?"valid":"invalid";$reason=$cIPResult[1];}else{$reason="bad-request";}}else{$reason="ratelimit";}return (object)['product'=>$product,'type'=>$type,'status'=>$status ?? "invalid",'reason'=>$reason];}function logRequest($request,$authResult){global $config;global $CMAnalytics;if($config['logging']['enabled']&&!is_null($CMAnalytics)&&!is_null($request)&&!is_null($authResult)){try{CMAnalyticsV2($config['logging']['webhook_url'],$config['logging']['embed_username'],$config['logging']['embed_avatar_url'],"PhantomAuth Request","",$config['logging']['embed_color_hex'],[["name"=>"Request Parameters","value"=>strval(json_encode($request,JSON_PRETTY_PRINT)),"inline"=>false],["name"=>"Authentication Result","value"=>strval(json_encode($authResult,JSON_PRETTY_PRINT)),"inline"=>false]]);}catch(Exception $e){}}}function outputJsonResponse($responseObj){echo json_encode($responseObj,JSON_PRETTY_PRINT);}function sanitizeUrlParams($params){$cleanParams=[];foreach($params as $key=>$value){$cleanParams[$key]=filter_var($value,FILTER_SANITIZE_STRING);}return $cleanParams;}initializeDirectories($config['productName']);$url='http://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];$url_components=parse_url($url);parse_str($url_components['query'],$params);$sanitizedParams=sanitizeUrlParams($params);$authResult=checkKeyAuth($sanitizedParams['product'],$sanitizedParams['key'],$sanitizedParams['type']);if($authResult->{'status'}=="valid"){$resourceContent=getResourceContent($sanitizedParams['request'],$sanitizedParams['product']);if($resourceContent!==false){$authResult->{'response'}=$resourceContent;}else{$authResult->{'response'}="Request type does not match any resource.";}}logRequest($sanitizedParams,$authResult);outputJsonResponse($authResult); ?>